/*
Exhance v0.3.2

http://dev.tthe.se/exhance

Copyright (c) 2014 Tomas Thelander 
Licensed under the MIT license
*/
(function($){$.fn.Exhance=function(input){if(this.length==0)return;if(typeof input=='object'||input==null){var options=$.extend({'ajax':false,'box':false,'boxBlock':false,'boxMenu':true,'indent':30,'hover':false,'links':true,'placeholder':'%exhance%','pre':false,'src':false,'type':'json','wrapper':'%exhance%','write':true,'xmlComments':true},input);var printString=function(str){var patternFirst=new RegExp('^https?:\\/\\/');var patternFull=new RegExp('^(https?:\\/\\/)?'+'((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+'((\\d{1,3}\\.){3}\\d{1,3}))'+'(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+'(\\?[;&a-z\\d%_.~+=-]*)?'+'(\\#[-a-z\\d_]*)?$','i');if(options.links){if(str.match(patternFirst)){if(str.match(patternFull)){return'<a href="'+str+'">'+str+'</a>'}}}return str};var level=0;var printJson=function(obj,comma){if(Object.prototype.toString.call(obj)==='[object Array]'){var string='<div class="exhance-inline">[</div>'+"\n";level++;for(i=0;i<obj.length;i++){if(i==obj.length-1)appendComma=false;else appendComma=true;string+=Array(level+1).join("\t")+'<div class="exhance-indent" style="margin-left:'+options.indent+'px;"><span class="exhance-bg">'+printJson(obj[i],appendComma)+'</span></div>'}level--;string+=Array(level+1).join("\t")+'<div style="margin-left: 0px;" class="exhance-inline">]</div>';if(comma){string+=','}return string+"\n"}else if(typeof obj=='object'&&obj!=null){var string='<div class="exhance-inline">{</div>'+"\n";var count=0;for(var name in obj){if(obj.hasOwnProperty(name)){count++}}var i=1;level++;for(var name in obj){if(obj.hasOwnProperty(name)){if(count==i)appendComma=false;else appendComma=true;string+=Array(level+1).join("\t")+'<div class="exhance-indent" style="margin-left:'+options.indent+'px;"><span class="exhance-bg"><span class="exhance-property">"'+name+'"</span> : '+printJson(obj[name],appendComma)+'</span></div>'}i++}level--;string+=Array(level+1).join("\t")+'<div style="margin-left:0px;" class="exhance-inline">}</div>';if(comma)string+=',';return string+"\n"}else if(typeof obj=='string'){return'<span class="exhance-string">"'+printString(obj)+'"</span>'+(comma?',':'')+"\n"}else if(typeof obj=='number'){return'<span class="exhance-number">'+obj.toString()+'</span>'+(comma?',':'')+"\n"}else if(typeof obj=='boolean'){return'<span class="exhance-boolean">'+obj.toString()+'</span>'+(comma?',':'')+"\n"}else if(typeof obj=='object'&&obj==null){return'<span class="exhance-null">null</span>'+(comma?',':'')+"\n"}else{return'undefined'+(comma?',':'')+"\n"}};var printXml=function(element){var returnString='';var xlevel=0;var last=null;$(element).contents().each(function processNodes(){xlevel++;if(xlevel>1){indentString='<div class="exhance-indent" style="margin-left: '+options.indent+'px;"><div class="exhance-bg">'}else{indentString='<div><div class="exhance-bg">'}if(this.nodeType==3){returnString+='<span class="exhance-x-text">'+printString(this.nodeValue)+'</span>';last='txt'}else if(this.nodeType==4){returnString+=indentString+'<span class="exhance-x-cdata">&lt;![CDATA['+this.nodeValue.replace(/</g,'&lt;').replace(/>/g,'&gt;')+']]&gt;</span></div></div>'}else if(this.nodeType==8){if(options.xmlComments){returnString+=indentString+'<span class="exhance-x-comment">&lt;!--'+this.nodeValue+'--&gt;</span></div></div>'}}else if(this.nodeType==1){returnString+=indentString;if((last!='txt'&&xlevel>1)||last=='end'){returnString+="\n"+Array(xlevel).join("\t")}returnString+='<span class="exhance-x-lt">&lt;</span><span class="exhance-x-tagname">'+this.tagName+'</span>';for(var i=0;i<this.attributes.length;i++){returnString+=' <span class="exhance-x-attrname">'+this.attributes[i].name+'</span><span class="exhance-x-attreq">=</span><span class="exhance-x-attrval">"'+printString(this.attributes[i].nodeValue)+'"</span>'}returnString+='<span class="exhance-x-gt">&gt;</span>';last='start';$(this).contents().each(processNodes);if(last!='txt'&&last!='start'){returnString+="\n"+Array(xlevel).join("\t")}returnString+='<span class="exhance-x-lt">&lt;/</span><span class="exhance-x-tagname">'+this.tagName+'</span><span class="exhance-x-gt">&gt;</span></div></div>';last='end'}xlevel--});return returnString};this.each(function(i,e){$(e).removeClass('exhance-error');if($(e).data().pre){$(e).removeClass('exhance-pre');$(e).data('pre',false)}if(options.type=='json'){if(options.src){if(options.ajax){$(e).html('Retrieving data...').addClass('exhance-container');$.ajax({type:"GET",url:options.src,dataType:"text",success:function(json){$(e).data('exhancePre',$.trim(json));options.src=options.ajax=false;$(e).Exhance(options)},error:function(){$(e).html('Exhance Ajax: An error occured when retrieving data.').addClass('exhance-error')}});return}else{var plaintext=$.trim($('#'+options.src).html())}}else{if($(e).data().exhancePre){var plaintext=$(e).data().exhancePre}else{var plaintext=$(e).html()}}try{var data=$.parseJSON(plaintext)}catch(err){$(e).html('Error parsing JSON.').addClass('exhance-container').addClass('exhance-error');return}level=0;var firstwrapper=options.wrapper.substr(0,options.wrapper.indexOf(options.placeholder));var lastwrapper=options.wrapper.substr(options.wrapper.indexOf(options.placeholder)+options.placeholder.length);var styledData=printJson(data);$(e).data('exhancePre',styledData.replace(/(<([^>]+)>)/ig,""));$(e).data('exhanceObj',data)}else if(options.type=='xml'){var parseXml;if(typeof window.DOMParser!="undefined"){parseXml=function(xmlStr){return(new window.DOMParser()).parseFromString(xmlStr,"text/xml")}}else if(typeof window.ActiveXObject!="undefined"&&new window.ActiveXObject("Microsoft.XMLDOM")){parseXml=function(xmlStr){var xmlDoc=new window.ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(xmlStr);return xmlDoc}}else{throw new Error("No XML parser found")}if(options.src){if(options.ajax){$(e).html('Retrieving data...').addClass('exhance-container');$.ajax({type:"GET",url:options.src,dataType:"xml",success:function(xml){$(e).data('exhanceObj',xml);options.src=options.ajax=false;$(e).Exhance(options)},error:function(){$(e).html('Exhance Ajax: An error occured when retrieving data.').addClass('exhance-error')}});return}else{data=parseXml('<exhance>'+$('#'+options.src).html()+'</exhance>').childNodes}}else{if($(e).data().exhanceObj){data=$(e).data().exhanceObj}else if($(e).data().exhanceXml){data=parseXml($(e).data().exhanceXml)}else{data=parseXml($(e).html())}}var firstwrapper='';var lastwrapper='';var styledData=printXml(data);$(e).data('exhancePre',styledData.replace(/(<([^>]+)>)/ig,""));$(e).data('exhanceXml',$(e).data().exhancePre.replace(/&lt;/gi,'<').replace(/&gt;/gi,'>'));$(e).data('exhanceObj',data)}else{return}var fullStyled='<span class="exhance-wrapper">'+firstwrapper+'</span>'+styledData+'<span class="exhance-wrapper">'+lastwrapper+'</span>';if(options.write){if(options.box){$(e).html('<div class="exhance-box"><div class="exhance-menu"></div><span class="exhance-bg"></span></div>').addClass('exhance-container');$(e).find('.exhance-menu').append('<a href="#" class="showColor">Colored</a><span class="menuSeparator"> | </span><a href="#" class="showPlain">Plain</a><span class="menuSeparator"> | </span><a href="#" class="minimize">Show/hide</a>');if(options.boxBlock){$(e).find('.exhance-box').css('display','block')}$(e).find('.showColor').click(function(ev){ev.preventDefault();$(e).removeClass('exhance-pre');$(e).find('.exhance-bg:first').html(fullStyled);if(options.hover){$(e).Exhance('hover')}});$(e).find('.showPlain').click(function(ev){ev.preventDefault();$(e).addClass('exhance-pre');$(e).find('.exhance-bg:first').html($(e).data().exhancePre);if(options.hover){$(e).Exhance('disableHover')}});$(e).find('.minimize').click(function(ev){ev.preventDefault();$(e).find('.exhance-bg:first').slideToggle();$(e).find(' .showColor, .showPlain, .menuSeparator').toggle()});if(!options.boxMenu){$(e).find('.exhance-menu').hide()}}else{$(e).html('<span class="exhance-bg"></span>').addClass('exhance-container')}$(e).find('.exhance-bg').html(fullStyled)}if(options.hover){$(e).Exhance('hover')}if(options.pre&&options.write&&!options.box){$(e).Exhance('pre')}else if(options.pre&&options.write&&options.box){$(e).find('.showPlain').click()}})}else if(input=='pre'){this.each(function(i,e){$(e).html($(e).data('exhancePre')).addClass('exhance-pre');$(e).data('pre',true)})}else if(input=='hover'){this.each(function(i,e){$(e).find('.exhance-bg').on('mouseover',function(ev){ev.stopPropagation();$(e).find('.exhance-bg').removeClass('exhance-indenthover');$(this).addClass('exhance-indenthover')}).on('mouseleave',function(ev){ev.stopPropagation();$(this).removeClass('exhance-indenthover')})})}else if(input=='disableHover'){this.each(function(i,e){$(e).find('.exhance-bg').off('mouseover').off('mouseleave')})}else if(input=='data'){return this.data().exhanceXml?this.data().exhanceXml:this.data().exhancePre}return this}})(jQuery);